# chrome-macos-linux-migration
**Migrate Chrome data, profiles, cookies, passwords, etc from macOS to Linux**

Use case: you have been using Chrome on macOS and you want to start using
Chrome on Linux (whether in a VM or natively) and you want to preserve
everything as you migrate over to Linux.

Usage steps:
1. Install Linux
2. Install Chrome on Linux
3. Start Chrome on Linux to initialize a default profile
4. Close Chrome on both Linux and macOS
5. Copy your `~/Library/Application\ Support/Google/Chrome` onto Linux
6. Run `./migrate.py`
7. The script will prompt you for your *Chrome Safe Storage* key, which you
   can get from Keychain Access on macOS
8. Start Chrome on Linux, all your tabs and sessions should re-open as-is

The script will then proceed to decrypt and re-encrypt various data stored in
SQLite, including cookies, login data (saved passwords), other securely stored
web data such as saved credit card information.

**Use at your own risk, always backup your data first!**

Note: Google seems to detect the shenanigans and will log you out forcefully,
which is a bit annoying.

If you keep using Chrome on macOS and want to regularly sync with Linux, use
`rsync` to copy incremental deltas over from macOS to Linux, just remember to
delete the files `SingletonCookie`, `SingletonLock`, `SingletonSocket` on
Linux before starting Chrome again. And Google will log you out again.

## Technical details

When copying the folder of a Google Chrome profile across OS, encrypted data
fails to be carried over because for whatever reason the OS-specific code in
the `OSCrypt` layer of Chrome is implemented differently for each OS. For
example, on macOS Chrome [generates](https://source.chromium.org/chromium/chromium/src/+/main:components/os_crypt/sync/keychain_password_mac.mm;drc=34ad7f3844f882baf3d31a6bc6e300acaa0e3fc8;bpv=0;bpt=1;l=41)
a random 16 byte key and stores it in the macOS keychain, and then uses it to derive a symmetric key used for encryption
using PBKDF2 with [1003 iterations](https://source.chromium.org/chromium/chromium/src/+/main:components/os_crypt/sync/os_crypt_mac.mm;drc=f7e7492036eb4d974b0af952b65e161dea4297f9;bpv=0;bpt=1;l=39).
The encrypted string is stored as a `v10` encrypted data, even though the
similar implementation on Linux calls it `v11`.
On Linux the `v10` implementation uses only [1 iteration](https://source.chromium.org/chromium/chromium/src/+/main:components/os_crypt/sync/os_crypt_linux.cc;drc=f7e7492036eb4d974b0af952b65e161dea4297f9;bpv=0;bpt=1;l=35)
and a [hardcoded password](https://source.chromium.org/chromium/chromium/src/+/main:components/os_crypt/sync/os_crypt_linux.cc;l=316;drc=f7e7492036eb4d974b0af952b65e161dea4297f9;bpv=0;bpt=1).
Therefore to migrate the encrypted data from macOS to Linux, one needs to get
the password generated by Chrome on macOS, use it to decrypt the data the macOS
way, and re-encrypt it the Linux way.

At first I thought I needed to import the macOS generated password onto Linux.
But to the best of my knowledge, that is not necessary. Maybe the script
could be made a tad bit more secure by storing the macOS password using
libsecret and switching to the `v11` encryption format. Neither approach
is truly secure as any attacker with access to the host can retrieve the
password and decrypt all the cookies etc.

For future reference, the libsecret password stored by Chrome on Linux can be:
1. retrieved with `secret-tool search --all xdg:schema chrome_libsecret_os_crypt_password_v2`
2. updated/set with `secret-tool store --label="Chrome Safe Storage" xdg:schema chrome_libsecret_os_crypt_password_v2 application chrome`
3. cleared with `secret-tool clear xdg:schema chrome_libsecret_os_crypt_password_v2`
